name: Build JAR & Deploy to EC2 (image rebuild on server)

on:
  push:
    branches: ["main"]

# üîß Ï†ÑÏó≠ Î≥ÄÏàò(ÌïÑÏöî Ïãú Ïó¨Í∏∞Îßå Í≥†ÏπòÎ©¥ Îê®)
env:
  JAVA_VERSION: "17"
  JAVA_DIST: "temurin"

  # ÎπåÎìú ÏÇ∞Ï∂úÎ¨º Í¥ÄÎ†®
  JAR_GLOB: "build/libs/*.jar"
  UPLOAD_DIR: "build/upload"
  UPLOAD_NAME: "app.new.jar"
  FINAL_NAME: "app.jar"

  # ÏõêÍ≤© ÏÑúÎ≤Ñ Í≤ΩÎ°ú
  DEPLOY_ROOT: "/home/ubuntu/arfni-deploy"
  APP_DIR: "/home/ubuntu/arfni-deploy/apps"
  BACKUP_DIR: "/home/ubuntu/arfni-deploy/apps/backups"

  # Docker / ÏÑúÎπÑÏä§
  DOCKER_SERVICE: "spring"
  DOCKER_COMPOSE: "sudo docker compose"
  DOCKER_BUILD_FLAGS: "--pull --no-cache"

  # .dockerignore ÏàòÏ†ï ÌÜ†Í∏Ä
  FIX_DOCKERIGNORE: "true"

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DIST }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure gradlew is executable
        run: chmod +x ./gradlew

      - name: Build Spring Boot JAR
        run: ./gradlew clean bootJar --no-daemon

      - name: Prepare upload artifact (rename to ${{ env.UPLOAD_NAME }})
        run: |
          set -euo pipefail
          JAR_PATH=$(ls -t ${{ env.JAR_GLOB }} | head -n1)
          echo "[INFO] Picked jar: ${JAR_PATH}"
          mkdir -p "${{ env.UPLOAD_DIR }}"
          cp -f "${JAR_PATH}" "${{ env.UPLOAD_DIR }}/${{ env.UPLOAD_NAME }}"
          ls -lh "${{ env.UPLOAD_DIR }}/${{ env.UPLOAD_NAME }}"

      - name: Ensure target dirs exist on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
            mkdir -p "${{ env.BACKUP_DIR }}"

      - name: Copy ${{ env.UPLOAD_NAME }} to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: ${{ env.UPLOAD_DIR }}/${{ env.UPLOAD_NAME }}
          target: ${{ env.APP_DIR }}
          overwrite: true
          # build/upload/<file> ‚Üí apps/<file>
          strip_components: 2

      - name: Backup previous JAR, swap, and restart
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
            cd "${{ env.DEPLOY_ROOT }}"

            # (ÏòµÏÖò) .dockerignore ÏàòÏ†ï
            if [ "${{ env.FIX_DOCKERIGNORE }}" = "true" ] && [ -f "${{ env.APP_DIR }}/.dockerignore" ]; then
              sed -i '/^\*\.jar$/d' "${{ env.APP_DIR }}/.dockerignore" || true
              sed -i '/^build\/\?$/d' "${{ env.APP_DIR }}/.dockerignore" || true
              sed -i '/\.jar/d'       "${{ env.APP_DIR }}/.dockerignore" || true
            fi

            # ÏÉà ÌååÏùº ÌôïÏù∏
            if [ ! -s "${{ env.APP_DIR }}/${{ env.UPLOAD_NAME }}" ]; then
              echo "[ERROR] ${{ env.APP_DIR }}/${{ env.UPLOAD_NAME }} not found or empty"
              exit 1
            fi

            # Í∏∞Ï°¥ JAR Î∞±ÏóÖ
            if [ -f "${{ env.APP_DIR }}/${{ env.FINAL_NAME }}" ]; then
              TS=$(date +%Y%m%d-%H%M%S)
              mv -f "${{ env.APP_DIR }}/${{ env.FINAL_NAME }}" "${{ env.BACKUP_DIR }}/app-${TS}.jar"
              echo "[INFO] Backed up to ${{ env.BACKUP_DIR }}/app-${TS}.jar"
            else
              echo "[INFO] No previous ${{ env.FINAL_NAME }} to backup."
            fi

            # Î∞±ÏóÖ 5Í∞ú Ïú†ÏßÄ
            ls -1t "${{ env.BACKUP_DIR }}"/app-*.jar 2>/dev/null | tail -n +6 | xargs -r rm -f

            # ÏÉà ÌååÏùºÎ°ú ÍµêÏ≤¥
            mv -f "${{ env.APP_DIR }}/${{ env.UPLOAD_NAME }}" "${{ env.APP_DIR }}/${{ env.FINAL_NAME }}"
            ls -lh "${{ env.APP_DIR }}/${{ env.FINAL_NAME }}"

            echo "[INFO] Docker compose rebuild..."
            ${{ env.DOCKER_COMPOSE }} down
            ${{ env.DOCKER_COMPOSE }} build ${{ env.DOCKER_BUILD_FLAGS }} ${{ env.DOCKER_SERVICE }}
            echo "[INFO] Starting ${{ env.DOCKER_SERVICE }}..."
            ${{ env.DOCKER_COMPOSE }} up -d ${{ env.DOCKER_SERVICE }}

            echo "[INFO] Running containers:"
            sudo docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"

            echo "[INFO] Tail ${{ env.DOCKER_SERVICE }} logs (last 80 lines):"
            CID=$(sudo docker ps -qf "name=${{ env.DOCKER_SERVICE }}" | head -n1 || true)
            if [ -n "${CID:-}" ]; then
              sudo docker logs --tail=80 "$CID" || true
            else
              echo "[WARN] ${{ env.DOCKER_SERVICE }} container not found"
            fi
